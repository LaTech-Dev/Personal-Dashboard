<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Work Tasks</title>

  <style>
    body {
      background-color: #f0f0f0;
      font-family: Arial, sans-serif;
      padding: 20px;
    }

    h2 {
      text-align: center;
    }

    #inputWrapper, #clearWrapper {
      text-align: center;
      margin: 20px;
    }

    input, button {
      padding: 10px;
      margin: 5px;
      font-size: 1rem;
    }

    table {
      width: 80%;
      margin: 20px auto;
      border-collapse: collapse;
      background-color: white;
    }

    th, td {
      border: 1px solid #444;
      padding: 10px;
      text-align: left;
    }

    th {
      background-color: #FFFACD;
      color: blue;
      text-decoration: underline;
    }

    button {
      cursor: pointer;
    }
  </style>
</head>

<body>

<h2>Work Tasks</h2>

<div id="inputWrapper">
  <input type="text" id="task" placeholder="Enter Task">
  <input type="date" id="due">
  <button onclick="addRow()">Add Task</button>
</div>

<table>
  <thead>
    <tr>
      <th>Due Date</th>
      <th>Task</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody id="tableBody"></tbody>
</table>

<div id="clearWrapper">
  <button onclick="clearAll()">Clear Active Tasks</button>
  <button onclick="window.location.replace('Export program.html')">Export</button>
</div>

<hr>

<h2>Finished Tasks</h2>

<table>
  <thead>
    <tr>
      <th>Finished On</th>
      <th>Due Date</th>
      <th>Task</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody id="finishedTableBody"></tbody>
</table>

<script>
window.onload = function () {
  renderTable();
  renderFinishedTable();
};

/* ================= ACTIVE TASKS ================= */

function renderTable() {
  var tableBody = document.getElementById('tableBody');
  tableBody.innerHTML = '';

  var data = JSON.parse(localStorage.getItem('tableData')) || [];
  var lastDate = null;

  data.sort(function (a, b) {
    return a.due.localeCompare(b.due);
  });

  data.forEach(function (entry) {

    if (entry.due !== lastDate) {
      var dateRow = document.createElement('tr');
      dateRow.innerHTML =
        '<td colspan="3" style="background:#e8e8e8;font-weight:bold;">' +
        formatDate(entry.due) +
        '</td>';
      tableBody.appendChild(dateRow);
      lastDate = entry.due;
    }

    var taskRow = document.createElement('tr');
    taskRow.innerHTML =
      '<td>' + escapeHtml(entry.due) + '</td>' +
      '<td>' + escapeHtml(entry.task) + '</td>' +
      '<td>' +
      '<button onclick="finishTask(\'' +
      escapeJs(entry.task) + '\',\'' +
      entry.due + '\')">Finished</button>' +
      '</td>';

    tableBody.appendChild(taskRow);
  });
}

function addRow() {
  var task = document.getElementById('task').value.trim();
  var due = document.getElementById('due').value.trim();

  if (!task || !due) return;

  var data = JSON.parse(localStorage.getItem('tableData')) || [];
  data.push({ task: task, due: due });

  localStorage.setItem('tableData', JSON.stringify(data));

  document.getElementById('task').value = '';
  document.getElementById('due').value = '';

  renderTable();
}

function finishTask(task, due) {
  var activeTasks = JSON.parse(localStorage.getItem('tableData')) || [];
  var finishedTasks = JSON.parse(localStorage.getItem('finishedTasks1')) || [];

  var remaining = [];
  var finishedTask = null;

  for (var i = 0; i < activeTasks.length; i++) {
    if (activeTasks[i].task === task && activeTasks[i].due === due) {
      finishedTask = activeTasks[i];
    } else {
      remaining.push(activeTasks[i]);
    }
  }

  if (finishedTask) {
    finishedTasks.push({
      task: finishedTask.task,
      due: finishedTask.due,
      finishedAt: new Date().toISOString()
    });
  }

  localStorage.setItem('tableData', JSON.stringify(remaining));
  localStorage.setItem('finishedTasks1', JSON.stringify(finishedTasks));

  renderTable();
  renderFinishedTable();
}

function clearAll() {
  if (confirm("Are you sure you want to clear active tasks?")) {
    localStorage.removeItem('tableData');
    renderTable();
  }
}

/* ================= FINISHED TASKS ================= */

function renderFinishedTable() {
  var tableBody = document.getElementById('finishedTableBody');
  tableBody.innerHTML = '';

  var finishedTasks = JSON.parse(localStorage.getItem('finishedTasks1')) || [];

  finishedTasks.forEach(function (task, index) {
    var row = document.createElement('tr');
    row.innerHTML =
      '<td>' + formatDate(task.finishedAt.split("T")[0]) + '</td>' +
      '<td>' + escapeHtml(task.due) + '</td>' +
      '<td>' + escapeHtml(task.task) + '</td>' +
      '<td>' +
        '<button onclick="restoreTask(' + index + ')">Restore</button> ' +
        '<button onclick="deleteFinishedTask(' + index + ')">Delete</button>' +
      '</td>';

    tableBody.appendChild(row);
  });
}

function deleteFinishedTask(index) {
  if (!confirm("Delete this finished task permanently?")) return;

  var finishedTasks = JSON.parse(localStorage.getItem('finishedTasks1')) || [];
  finishedTasks.splice(index, 1);

  localStorage.setItem(
    'finishedTasks1',
    JSON.stringify(finishedTasks)
  );

  renderFinishedTable();
}



function restoreTask(index) {
  var finishedTasks = JSON.parse(localStorage.getItem('finishedTasks1')) || [];
  var activeTasks = JSON.parse(localStorage.getItem('tableData')) || [];

  var task = finishedTasks.splice(index, 1)[0];

  if (task) {
    activeTasks.push({ task: task.task, due: task.due });
  }

  localStorage.setItem('tableData', JSON.stringify(activeTasks));
  localStorage.setItem('finishedTasks1', JSON.stringify(finishedTasks));

  renderTable();
  renderFinishedTable();
}

/* ================= UTILITIES ================= */

function escapeHtml(text) {
  var div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function escapeJs(text) {
  return text.replace(/\\/g, "\\\\").replace(/'/g, "\\'");
}

function formatDate(iso) {
  return new Date(iso + "T00:00:00").toLocaleDateString();
}
</script>

</body>
</html>
